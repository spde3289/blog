name: Deploy Release to Vercel

on:
  workflow_run:
    workflows: ["Create release & tag"]
    types: [completed]

jobs:
  deploy:
    name: deploy
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      # 1) 빌드 zip 아티팩트만 받기
      - name: Download prebuilt build artifact
        uses: actions/download-artifact@v4
        with:
          name: prebuilt-build

      # 2) 파일 이름에서 버전 추출 (build-v0.1.4.zip → v0.1.4)
      - name: Extract release version from artifact name
        run: |
          FILE=$(ls build-*.zip)
          VERSION=${FILE#build-}
          VERSION=${VERSION%.zip}
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Release version is $RELEASE_VERSION"

      # 3) 압축 풀기
      - name: Unzip prebuilt build
        run: |
          ls -al
          unzip build-*.zip
          ls -al

      - name: Print release version
        run: echo "Release version is $RELEASE_VERSION"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          cache: yarn

      - name: Install Vercel CLI
        run: yarn global add vercel@latest

      - name: Pull Vercel env (production)
        run: vercel pull --yes --environment=production --token "${VERCEL_TOKEN}"

      - name: Deploy to Vercel (Production, prebuilt)
        run: vercel deploy --prebuilt --prod --token "${VERCEL_TOKEN}"
