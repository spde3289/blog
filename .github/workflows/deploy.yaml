name: Deploy Release to Vercel

on:
  workflow_run:
    workflows: ["Create release & tag"]
    types: [completed]

jobs:
  deploy:
    # Create release & tag 이 성공한 경우에만 배포 실행 (옵션이지만 추천)
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: deploy
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      # 1) 빌드 zip 아티팩트 받기 (다른 워크플로우 run에서)
      - name: Download prebuilt build artifact
        uses: actions/download-artifact@v4
        with:
          name: prebuilt-build
          repository: ${{ github.repository }}
          run-id: ${{ github.event.workflow_run.id }}
          path: .

      - name: Extract release version from artifact name
        run: |
          ls -R
          FILE=$(ls prebuilt-build/build-*.zip)
          BASENAME=$(basename "$FILE")
          VERSION=${BASENAME#build-}
          VERSION=${VERSION%.zip}
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Release version is $VERSION"

      # 3) 압축 풀기 (prebuilt-build 폴더 안의 zip을 unzip)
      - name: Unzip prebuilt build
        run: |
          FILE=$(ls prebuilt-build/build-*.zip)
          echo "Unzipping $FILE"
          unzip "$FILE"
          echo "After unzip:"
          ls -R

      - name: Print release version
        run: echo "Release version is $RELEASE_VERSION"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          cache: yarn

      - name: Install Vercel CLI
        run: yarn global add vercel@latest

      - name: Pull Vercel env (production)
        run: vercel pull --yes --environment=production --token "${VERCEL_TOKEN}"

      - name: Deploy to Vercel (Production)
        run: vercel deploy --prod --token "${VERCEL_TOKEN}"
