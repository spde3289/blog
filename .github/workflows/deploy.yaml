name: Deploy Release to Vercel

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      # (옵션) 소스도 같이 보고 싶으면
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      # 1) TAG 가져오기 (ex: v0.1.4)
      - name: Set TAG env
        run: |
          echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_ENV
          echo "TAG=${{ github.event.release.tag_name }}"

      # 2) 릴리즈에서 build-${TAG}.zip 다운로드
      - name: Download build zip from release assets
        run: |
          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          TAG="${TAG}"

          echo "Owner: $OWNER"
          echo "Repo : $REPO"
          echo "Tag  : $TAG"

          API="https://api.github.com/repos/$OWNER/$REPO/releases/tags/$TAG"

          # 릴리즈 정보 가져오기
          JSON=$(curl -sSL \
            -H "Authorization: Bearer ${{ secrets.TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API")

          URL=$(echo "$JSON" | jq -r \
            --arg NAME "build-$TAG.zip" \
            '.assets[] | select(.name == $NAME) | .browser_download_url')

          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "❌ build-$TAG.zip 을 릴리즈에서 찾지 못했어."
            exit 1
          fi

          echo "Download URL: $URL"

          curl -L \
            -H "Authorization: Bearer ${{ secrets.TOKEN }}" \
            "$URL" \
            -o "build-$TAG.zip"

          echo "Downloaded build-$TAG.zip"
          ls -al

      # 3) 압축 풀기 (안에 .next 또는 .vercel/output 이 있을 거라고 가정)
      - name: Unzip build
        run: |
          unzip "build-$TAG.zip"
          echo "After unzip:"
          ls -R

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: yarn

      - name: Install Vercel CLI
        run: yarn global add vercel@latest

      - name: Pull Vercel env (production)
        run: vercel pull --yes --environment=production --token "${VERCEL_TOKEN}"

      # ⚠ zip 안에 뭐가 들어있는지에 따라 여기 옵션이 달라짐
      # - .next만 들어 있다면: Vercel이 다시 빌드할 거라 그냥 --prod
      # - .vercel/output 이 들어 있다면: --prebuilt 사용 가능
      - name: Deploy to Vercel (Production)
        run: vercel deploy --prebuilt --token "${VERCEL_TOKEN}"
