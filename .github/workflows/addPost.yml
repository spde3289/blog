name: AddPost → Main 자동 머지

on:
  push:
    branches: [addPost] # addPost에 push될 때만 실행

permissions:
  contents: write # 머지/푸시에 필요
  pull-requests: write # PR 생성/머지에 필요

concurrency:
  group: addPost-ci
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Install deps
        run: yarn --frozen-lockfile

      - name: Lint
        run: yarn lint
        
      - name: Build
        run: yarn build

  merge_to_main:
   needs: ci
    runs-on: ubuntu-latest
    env:
      BASE_BRANCH: ${{ github.event.repository.default_branch }}  # ← 기본 브랜치 자동 사용
    steps:
      - name: Open PR (addPost → ${{ env.BASE_BRANCH }}) if missing and merge it
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const base  = process.env.BASE_BRANCH;   // main 또는 master
            const head  = 'addPost';

            // 동일한 PR 열려있으면 재사용
            const { data: prs } = await github.rest.pulls.list({
              owner, repo, state: 'open', head: `${owner}:${head}`, base
            });
            let pr = prs[0];

            // 없으면 생성
            if (!pr) {
              pr = (await github.rest.pulls.create({
                owner, repo, title: `CI: ${head} → ${base} (build passed)`,
                head, base, body: '빌드 성공 → 자동 머지'
              })).data;
            }

            // 머지
            await github.rest.pulls.merge({
              owner, repo, pull_number: pr.number, merge_method: 'squash'
            });
            await github.rest.pulls.merge({
              owner, repo, pull_number: pr.number, merge_method: 'squash'
            });
