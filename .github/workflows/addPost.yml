name: AddPost → Main 자동 머지

on:
  push:
    branches: [addPost] # addPost에 push될 때만 실행

permissions:
  contents: write # 머지/푸시에 필요
  pull-requests: write # PR 생성/머지에 필요

concurrency:
  group: addPost-ci
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Install deps
        run: yarn --frozen-lockfile

      - name: Lint
        run: yarn lint
        
      - name: Build
        run: yarn build

  merge_to_main:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Open/merge PR to default branch
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // 1) 기본 브랜치 조회 (main 또는 master)
            const repoInfo = await github.rest.repos.get({ owner, repo });
            const base = repoInfo.data.default_branch; // e.g. 'main' or 'master'
            const head = 'addPost';

            // 2) 동일 PR이 열려 있으면 재사용
            const { data: prs } = await github.rest.pulls.list({
              owner, repo, state: 'open', head: `${owner}:${head}`, base
            });
            let pr = prs[0];

            // 3) 없으면 생성
            if (!pr) {
              pr = (await github.rest.pulls.create({
                owner, repo,
                title: `CI: ${head} → ${base} (build passed)`,
                head, base,
                body: '빌드 성공 → 자동 머지'
              })).data;
            }

            // 4) 머지 (필요시 merge_method: 'merge' | 'rebase' 로 교체)
            await github.rest.pulls.merge({
              owner, repo, pull_number: pr.number, merge_method: 'squash'
            });
