name: AddPost â†’ Default PR ìë™ ìƒì„±

on:
  push:
    branches:
      - addPost # addPostì— pushë  ë•Œë§Œ ì‹¤í–‰

permissions:
  contents: write # ì½”ë“œ ì ‘ê·¼ìš©
  pull-requests: write # PR ìƒì„± ê¶Œí•œ

concurrency:
  group: addPost-ci
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # - uses: actions/setup-node@v4
      #   with:
      #     node-version: 20
      #     cache: yarn

      # - name: Install deps
      #   run: yarn --frozen-lockfile

      # - name: Lint
      #   run: yarn lint

      # - name: Build
      #   run: yarn build

  create_pr:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Create Pull Request to default branch if missing
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const { data: repoInfo } = await github.rest.repos.get({ owner, repo });
            const base = repoInfo.default_branch;   
            const head = 'addPost';

            // (ì„ íƒ) ì°¨ì´ê°€ ì—†ìœ¼ë©´ PR ìƒì„±/ë¨¸ì§€ ìŠ¤í‚µ
            try {
              const { data: cmp } = await github.rest.repos.compareCommitsWithBasehead({
                owner, repo, basehead: `${base}...${head}`
              });
              if (cmp.ahead_by === 0) {
                core.info(`ğŸ” No commits between ${base} and ${head}. Skip.`);
                return;
              }
            } catch (e) {
              core.warning(`compare failed (maybe branch missing?): ${e.message}`);
            }

            // ì—´ë ¤ìˆëŠ” PR ì¬ì‚¬ìš© ë˜ëŠ” ìƒˆë¡œ ìƒì„±
            const { data: prs } = await github.rest.pulls.list({
              owner, repo, state: 'open', head: `${owner}:${head}`, base
            });
            let pr = prs[0];

            if (!pr) {
              pr = (await github.rest.pulls.create({
                owner, repo,
                title: `Auto PR: ${head} â†’ ${base}`,
                head, base,
                body: 'ğŸ“¦ addPost ë¸Œëœì¹˜ ë³€ê²½ ê°ì§€ PR (ìë™ ìƒì„±)',
              })).data;
              core.info(`ğŸ‰ Created PR #${pr.number}: ${pr.html_url}`);
            } else {
              core.info(`âœ… Reusing PR #${pr.number}: ${pr.html_url}`);
            }

            await github.rest.pulls.merge({
              owner, repo, pull_number: pr.number, merge_method: 'squash'
            });
            core.info(`ğŸš€ Merged PR #${pr.number}`);
