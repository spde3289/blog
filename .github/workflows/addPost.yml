name: AddPost â†’ Default PR ìë™ ìƒì„±

on:
  push:
    branches:
      - addPost # addPostì— pushë  ë•Œë§Œ ì‹¤í–‰

permissions:
  contents: write # ì½”ë“œ ì ‘ê·¼ìš©
  pull-requests: write # PR ìƒì„± ê¶Œí•œ

concurrency:
  group: addPost-ci
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Install deps
        run: yarn --frozen-lockfile

      - name: Lint
        run: yarn lint

      - name: Build
        run: yarn build

  create_pr:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Create Pull Request to default branch if missing
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            // ê¸°ë³¸ ë¸Œëœì¹˜
            const repoInfo = await github.rest.repos.get({ owner, repo });
            const base = repoInfo.data.default_branch; 
            const head = 'addPost';

            // ì´ë¯¸ ì—´ë ¤ ìˆëŠ” PRì´ ìˆëŠ”ì§€ í™•ì¸
            const { data: prs } = await github.rest.pulls.list({
              owner, repo, state: 'open', head: `${owner}:${head}`, base
            });

            if (prs.length > 0) {
              core.info(`âœ… PR already exists: #${prs[0].number} (${prs[0].html_url})`);
            } else {
              const { data: pr } = await github.rest.pulls.create({
                owner, repo,
                title: `Auto PR: ${head} â†’ ${base}`,
                head, base,
                body: 'ğŸ“¦ addPost ë¸Œëœì¹˜ì—ì„œ ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì–´ ìë™ìœ¼ë¡œ ìƒì„±ëœ PRì…ë‹ˆë‹¤. ë¦¬ë·° í›„ ë¨¸ì§€í•´ì£¼ì„¸ìš” ğŸ™Œ',
              });
              core.info(`ğŸ‰ Created PR #${pr.number}: ${pr.html_url}`);
            }

            await github.rest.pulls.merge({
              owner, repo, pull_number: pr.number, merge_method: 'squash'
            });
            core.info(`ğŸš€ Merged PR #${pr.number}`);
